// conditioner v0.8.8 - ConditionerJS - Take control of your JavaScript modules.
// Copyright (c) 2013 Rik Schennink - http://rikschennink.github.io/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(["require"],function(t){"use strict";var e=function(){var t=null,e=null,i=document?document.body:null;!i||i.matches?e="matches":i.webkitMatchesSelector?e="webkitMatchesSelector":i.mozMatchesSelector?e="mozMatchesSelector":i.msMatchesSelector?e="msMatchesSelector":i.oMatchesSelector&&(e="oMatchesSelector"),t=e?function(t,i){t[e](i)}:function(t,e){for(var i=(t.parentNode||document).querySelectorAll(e)||[],o=i.length;o--;)if(i[o]==t)return!0;return!1};var o={mergeObjects:function(t,e){var i=Array.isArray(e),n=i&&[]||{};return e=e||{},i?(t=t||[],n=n.concat(t),e.forEach(function(e,i){"object"==typeof e?n[i]=o.mergeObjects(t[i],e):-1===t.indexOf(e)&&n.push(e)})):(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(i){n[i]="object"==typeof e[i]&&e[i]?t[i]?o.mergeObjects(t[i],e[i]):e[i]:e[i]})),n},matchesSelector:function(e,i){return e?t(e,i):!1}};return o}(),i={subscribe:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var o,n=0,s=t._subscriptions;s>n;n++)if(o=t._subscriptions[n],o.type===e&&o.fn===i)return;t._subscriptions.push({type:e,fn:i})},unsubscribe:function(t,e,i){if(t._subscriptions)for(var o,n=t._subscriptions.length;--n>=0;)if(o=t._subscriptions[n],o.type===e&&o.fn===i){t._subscriptions.splice(n,1);break}},publish:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var o,n=[],s=0,r=t._subscriptions.length;r>s;s++)o=t._subscriptions[s],o.type===e&&n.push(o);for(r=n.length,s=0;r>s;s++)n[s].fn(i);if(t._receivers)for(r=t._receivers.length,s=0;r>s;s++)this.publish(t._receivers[s],e,i)},inform:function(t,e){return t&&e?(t._receivers||(t._receivers=[]),t._receivers.push(e),!0):!1},conceal:function(t,e){if(!t||!e||!t._receivers)return!1;for(var i,o=t._receivers.length;--o>=0;)if(i=t._receivers[o],i===e)return t._receivers.splice(o,1),!0;return!1}},o=function(){};o.prototype={succeeds:function(){},getConfig:function(){}};var n=function(t,e){this._expression=t instanceof s||t instanceof n?t:null,this._config=this._expression?null:t,this._negate=e===void 0?!1:e};n.prototype=Object.create(o),n.prototype.assignTester=function(t){this._expression=t},n.prototype.getConfig=function(){return this._config?[{expression:this,config:this._config}]:this._expression.getConfig()},n.prototype.succeeds=function(){return this._expression.succeeds?this._expression.succeeds()!==this._negate:!1},n.prototype.toString=function(){return(this._negate?"not ":"")+(this._expression?""+this._expression:this._config.path+":{"+this._config.value+"}")};var s=function(t,e,i){this._a=t,this._operator=e,this._b=i};s.prototype=Object.create(o),s.prototype.succeeds=function(){return"and"===this._operator?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()},s.prototype.toString=function(){return"("+(""+this._a)+" "+this._operator+" "+(""+this._b)+")"},s.prototype.getConfig=function(){return[this._a.getConfig(),this._b.getConfig()]};var r={getExpressionsCount:function(t){return t.match(/(:\{)/g).length},fromString:function(t){var e,i,o,r,u,l,a,h,c,d,_=0,f="",p=[],m="",g=!1,v=!1,b=null,y=null,M=[],C=t.length;for(b||(b=p);C>_;_++)if(u=t.charAt(_),"{"!==u)if("}"===u&&(e=b.length-1,i=e+1,g="not"===b[e],i=g?e:e+1,b[i]=new n({path:f,value:m},g),f="",m="",g=!1,v=!1),v)m+=u;else{if("("===u&&(b.push([]),M.push(b),b=b[b.length-1])," "===u||0===_||"("===u){if(o=t.substr(_,5).match(/and |or |not /g),!o)continue;h=o[0],c=h.length-1,b.push(h.substring(0,c)),_+=c}if(")"===u||_===C-1)do if(y=M.pop(),0!==b.length){for(r=0,d=b.length;d>r;r++)"string"==typeof b[r]&&("not"===b[r]?(b.splice(r,2,new n(b[r+1],!0)),r=-1,d=b.length):"not"!==b[r+1]&&(b.splice(r-1,3,new s(b[r-1],b[r],b[r+1])),r=-1,d=b.length));1===b.length&&y&&(y[y.length-1]=b[0],b=y)}else b=y;while(_===C-1&&y)}else for(v=!0,f="",l=_-2;l>=0&&(a=t.charAt(l)," "!==a&&"("!==a);)f=a+f,l--;return 1===p.length?p[0]:p}},u={_tests:{},_createTest:function(t,e){if(!e.assert)throw Error('TestRegister._addTest(path,config): "config.assert" is a required parameter.');var o=function(){};return o.supported="support"in e?e.support():!0,o._callbacks=[],o._ready=!1,o._setup=function(t){o.supported&&(o._callbacks.push(t.onchange.bind(t)),o._ready||(o._ready=!0,e.setup.call(o,o._measure)))},o._measure=function(t){var i="measure"in e?e.measure.call(o._measure,t):!0;if(i)for(var n=0,s=o._callbacks.length;s>n;n++)o._callbacks[n](t)},o.prototype.supported=function(){return o.supported},o.prototype.onchange=function(){i.publish(this,"change")},o.prototype.arrange=e.arrange?function(t,i){o.supported&&e.arrange.call(this,t,i)}:function(){o._setup(this)},e.measure&&(o.prototype.measure=e.measure),o.prototype.assert=e.assert,o},_findTest:function(t){return this._tests[t]},_storeTest:function(t,e){this._tests[t]=e},getTest:function(e,i){e="tests/"+e,t([e],function(t){var o=u._findTest(e);o||(o=u._createTest(e,t),u._storeTest(e,o)),i(new o)})}},l=function(t,e,o){this._test=t,this._expected=e,this._element=o,this._result=!1,this._changed=!0;var n=this;i.subscribe(this._test,"change",function(){n._changed=!0}),this._test.arrange(this._expected,this._element)};l.prototype.succeeds=function(){return this._changed&&(this._changed=!1,this._result=this._test.assert(this._expected,this._element)),this._result};var a={_modules:{},registerModule:function(t,e,i){var o,n,s=i||t;this._modules[s]={},e&&(this._modules[s].config=e,n={},n[t]=e,requirejs.config({config:n})),i&&(this._modules[s].alias=i,o={},o[i]=t,requirejs.config({map:{"*":o}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},h=function(t,e){this._suitable=!0,"string"==typeof t&&(this._suitable=!1,this._element=e,this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=r.getExpressionsCount(t),this._expression=r.fromString(t),this._loadExpressionTests(this._expression.getConfig()))};h.prototype={getSuitability:function(){return this._suitable},test:function(){var t=this._expression.succeeds();t!=this._suitable&&(this._suitable=t,i.publish(this,"change"))},_loadExpressionTests:function(t){for(var e=0,i=t.length;i>e;e++)Array.isArray(t[e])?this._loadExpressionTests(t[e]):this._loadTesterToExpression(t[e].config,t[e].expression)},_loadTesterToExpression:function(t,e){var o=this;u.getTest(t.path,function(n){e.assignTester(new l(n,t.value,o._element)),i.subscribe(n,"change",o._onResultsChangedBind),o._count--,0===o._count&&o._onReady()})},_onReady:function(){this.test(),i.publish(this,"ready",this._suitable)},_onTestResultsChanged:function(){this.test()}};var c=function(t,e,o){if(!t||!e)throw Error('ModuleController(path,element,options): "path" and "element" are required parameters.');this._path=t,this._element=e,this._options=o||{},this._Module=null,this._module=null,this._conditionsManager=new h(this._options.conditions,this._element),i.subscribe(this._conditionsManager,"ready",this._onReady.bind(this)),this._ready=!this.isConditioned()||this._conditionsManager.getSuitability(),this._available=!1};c.prototype={isAvailable:function(){return this._available=this._conditionsManager.getSuitability(),this._available},isActive:function(){return null!==this._module},isConditioned:function(){return this._options.conditions!==void 0},isReady:function(){return this._ready},matchesPath:function(t){return this._path===t},_onReady:function(t){this._ready=!0,i.subscribe(this._conditionsManager,"change",this._onConditionsChange.bind(this)),i.publish(this,"ready"),t&&this._onAvailable()},_onAvailable:function(){this._available=!0,i.publish(this,"available",this)},_onConditionsChange:function(){var t=this._conditionsManager.getSuitability();this._module&&!t&&this.unload(),!this._module&&t&&this._onAvailable()},load:function(){if(this._Module)return this._onLoad(),void 0;var e=this;t([this._path],function(t){e._Module=t,e._onLoad()})},_onLoad:function(){if(this.isAvailable()){var t,o=a.getModuleByPath(this._path),n=o?o.config:{},s={};if("string"==typeof this._options.options)try{s=JSON.parse(this._options.options)}catch(r){throw Error('ModuleController.load(): "options" is not a valid JSON string.')}else s=this._options.options;if(t=n?e.mergeObjects(n,s):s,t=this._Module.options?e.mergeObjects(this._Module.options,t):t,"function"==typeof this._Module?this._module=new this._Module(this._element,t):(this._module=this._Module.load?this._Module.load(this._element,t):null,this._module===void 0&&(this._module=this._Module)),!this._module)throw Error('ModuleController.load(): could not initialize module, missing constructor or "load" method.');this._element.setAttribute("data-initialized",this._path),i.inform(this._module,this),i.publish(this,"load",this)}},unload:function(){return this._available=!1,this._module?(i.conceal(this._module,this),this._module.unload&&this._module.unload(),this._element.removeAttribute("data-initialized"),this._module=null,i.publish(this,"unload",this),!0):!1},execute:function(t,e){if(!this._module)return{status:404,response:null};var i=this._module[t];if(!i)throw Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return{status:200,response:i.apply(this._module,e)}}};var d=function(t){if(!t)throw Error('Node: "element" is a required parameter.');this._element=t,this._element.setAttribute("data-processed","true");var e=this._element.getAttribute("data-priority");this._priority=e?parseInt(e,10):0,this._moduleControllers=[],this._activeModuleController=null,this._activeModuleUnloadBind=this._onActiveModuleUnload.bind(this)};d.hasProcessed=function(t){return"true"===t.getAttribute("data-processed")},d.prototype={init:function(){this._moduleControllers=this._createModuleControllers();var t,e=0,o=this._moduleControllers.length;if(!o)throw Error('Node: "element" has to have a "data-module" attribute containing a reference to a Module.');for(;o>e;e++)t=this._moduleControllers[e],t.isReady()?this._onModuleReady():i.subscribe(t,"ready",this._onModuleReady.bind(this))},getPriority:function(){return this._priority},matchesSelector:function(t){return e.matchesSelector(this._element,t)},getActiveModuleController:function(){return this._activeModuleController},getModuleController:function(t){return this.getModuleControllerAll(t)[0]},getModuleControllerAll:function(t){if(t===void 0)return this._moduleControllers.concat();for(var e,i=0,o=this._moduleControllers.length,n=[];o>i;i++)e=this._moduleControllers[i],e.matchesPath(t)&&n.push(e);return n},execute:function(t,e){return this._activeModuleController?this._activeModuleController.execute(t,e):{status:404,response:null}},_onModuleReady:function(){for(var t=this._moduleControllers.length;--t>=0;)if(!this._moduleControllers[t].isReady())return;this._onModulesReady()},_onModulesReady:function(){var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t);for(var e=0,o=this._moduleControllers.length;o>e;e++)i.subscribe(this._moduleControllers[e],"available",this._onModuleAvailable.bind(this))},_onModuleAvailable:function(t){for(var e,i=0,o=this._moduleControllers.length;o>i;i++)if(e=this._moduleControllers[i],e!==t&&e.isAvailable()&&e.isConditioned())return;this._setActiveModuleController(t)},_setActiveModuleController:function(t){t!==this._activeModuleController&&(this._cleanActiveModuleController(),this._activeModuleController=t,i.subscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),i.inform(this._activeModuleController,this),this._activeModuleController.load())},_cleanActiveModuleController:function(){this._activeModuleController&&(i.unsubscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),i.conceal(this._activeModuleController,this),this._activeModuleController.unload(),this._activeModuleController=null)},_onActiveModuleUnload:function(){this._cleanActiveModuleController();var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t)},_getSuitableActiveModuleController:function(){for(var t,e=0,i=this._moduleControllers.length;i>e;e++)if(t=this._moduleControllers[e],t.isAvailable())return t;return null},_createModuleControllers:function(){var t=[],e=this._element.getAttribute("data-module")||"",i="["===e.charAt(0);if(i){var o;try{o=JSON.parse(e)}catch(n){throw Error('Node: "data-module" attribute containing a malformed JSON string.')}if(!o)return[];for(var s,r=o.length,u=0;r>u;u++)s=o[u],t.push(new c(s.path,this._element,{conditions:s.conditions,options:s.options}))}else e.length&&t.push(new c(e,this._element,{conditions:this._element.getAttribute("data-conditions"),options:this._element.getAttribute("data-options")}));return t}};var _=function(){this._options={modules:{}},this._nodes=[],this.Observer=i,this.mergeObjects=e.mergeObjects};return _.prototype={setOptions:function(t){if(!t)throw Error('Conditioner.setOptions(options): "options" is a required parameter.');this._options=e.mergeObjects(this._options,t);var i,o,n,s;for(o in this._options.modules)this._options.modules.hasOwnProperty(o)&&(n=this._options.modules[o],s="string"==typeof n?n:n.alias,i="string"==typeof n?null:n.options||{},a.registerModule(o,i,s))},loadModules:function(t){if(!t)throw Error('Conditioner.loadModules(context): "context" is a required parameter.');var e,i=t.querySelectorAll("[data-module]"),o=i.length,n=0,s=[];if(!i)return[];for(;o>n;n++)e=i[n],d.hasProcessed(e)||s.push(new d(e));for(s.sort(function(t,e){return t.getPriority()-e.getPriority()}),n=s.length;--n>=0;)s[n].init();return this._nodes=this._nodes.concat(s),s},getNode:function(t){return this.getNodesAll(t)[0]},getNodesAll:function(t){if(t===void 0)return this._nodes.concat();for(var e,i=0,o=this._nodes.length,n=[];o>i;i++)e=this._nodes[i],e.matchesSelector(t)&&n.push(e);return n}},new _});