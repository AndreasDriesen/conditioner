// conditioner v0.8.1 - A JavaScript framework for conditionally loading UI classes
// Copyright (c) 2013 Rik Schennink - https://github.com/rikschennink/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(["require"],function(t){"use strict";var e=function(){var t=null,e=document.body;e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector");var i={mergeObjects:function(t,e){var o=Array.isArray(e),n=o&&[]||{};return e=e||{},o?(t=t||[],n=n.concat(t),e.forEach(function(e,i){"object"==typeof e?n[i]=mergeObjects(t[i],e):-1===t.indexOf(e)&&n.push(e)})):(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(o){n[o]="object"==typeof e[o]&&e[o]?t[o]?i.mergeObjects(t[o],e[o]):e[o]:e[o]})),n},matchesSelector:function(e,i){return e&&t?e[t](i):!1}};return i}(),i={subscribe:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var o,n=0,s=t._subscriptions;s>n;n++)if(o=t._subscriptions[n],o.type==e&&o.fn==i)return;t._subscriptions.push({type:e,fn:i})},unsubscribe:function(t,e,i){if(t._subscriptions){var o,n;for(n=t._subscriptions.length-1;n>=0;n--)if(o=t._subscriptions[n],o.type==e&&o.fn==i){t._subscriptions.splice(n,1);break}}},publish:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var o,n=[],s=0,r=t._subscriptions.length;r>s;s++)o=t._subscriptions[s],o.type==e&&n.push(o);for(r=n.length,s=0;r>s;s++)n[s].fn(i);t._eventPropagationTarget&&this.publish(t._eventPropagationTarget,e,i)},setupPropagationTarget:function(t,e){return t&&e?(t._eventPropagationTarget=e,!0):!1},removePropagationTarget:function(t,e){return t&&e?t._eventPropagationTarget===e?(t._eventPropagationTarget=null,!0):!1:!1}},o=function(t,i){if(!t)throw Error('BehaviorBase(element,options): "element" is a required parameter.');this._element=t,this._element.setAttribute("data-initialized","true"),this._options=this._options||{},this._options=i?e.mergeObjects(this._options,i):this._options};o.prototype._unload=function(){this._element.removeAttribute("data-initialized")};var n=function(t,e){this._expected=t,this._element=e,this._state=!0};n.inherit=function(){var t=function(t,e){n.call(this,t,e)};return t.prototype=Object.create(n.prototype),t},n.prototype._test=function(){},n.prototype.arrange=function(){},n.prototype.assert=function(){var t=this._test(this._expected);this._state!==t&&(this._state=t,i.publish(this,"change",t))},n.prototype.succeeds=function(){return this._state};var s={_modules:{},registerModule:function(t,e,i){var o,n,s=i||t;this._modules[s]={},e&&(this._modules[s].config=e,n={},n[t]=e,requirejs.config({config:n})),i&&(this._modules[s].alias=i,o={},o[i]=t,requirejs.config({map:{"*":o}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},r={succeeds:function(){}},a=function(t){this._test=t};a.prototype=Object.create(r),a.prototype.setTest=function(t){this._test=t},a.prototype.succeeds=function(){return this._test?this._test.succeeds():!1};var u=function(t,e,i){this._a=t,this._o=e,this._b=i};u.prototype=Object.create(r),u.prototype.succeeds=function(){return"and"===this._o?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()};var l=function(t,e){if(this._suitable=!0,"string"==typeof t){this._suitable=!1,this._element=e,this._tests=[],this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=t.match(/(\:\{)/g).length;var i=this._parseCondition(t);this._expression=this._loadExpression(i)}};l.prototype={getSuitability:function(){return this._suitable},_parseCondition:function(t){var e,i,o,n,s=0,r="",a=[],u="",l=!1,h=null,c=null,d=null,p=[],_=t.length;for(h||(h=a);_>s;s++)if(e=t.charAt(s),"{"!==e)if("}"!==e)if(l)u+=e;else if(" "!==e){if("("===e)h.push([]),p.push(h),h=h[h.length-1];else if((")"===e||s===_-1)&&(c=null,d=p.pop(),(1===h.length||d&&1===d.length&&s===_-1)&&(c=h.concat()),h=d,c&&h))for(h.pop(),i=0;c.length>i;i++)h.push(c[i])}else n=t.substr(s,4).match(/and|or/g),n&&(h.push(n[0]),s+=n[0].length+1);else h.push({path:r,value:u}),r="",u="",l=!1;else for(l=!0,r="",i=s-2;i>=0&&(o=t.charAt(i)," "!==o&&"("!==o);)r=o+r,i--;return this._makeImplicit(a),1===a.length?a[0]:a},_makeImplicit:function(t){for(var e=0,i=t.length;i>e;e++)i>3?(t.splice(e,3,t.slice(e,e+3)),i=t.length,e=-1):"string"!=typeof t[e]&&this._makeImplicit(t[e])},_loadExpression:function(t){return 3===t.length?new u(this._loadExpression(t[0]),t[1],this._loadExpression(t[2])):this._createUnaryExpressionFromTest(t)},_createUnaryExpressionFromTest:function(e){var i=new a(null),o=null,n=this;return t(["tests/"+e.path],function(t){o=new t(e.value,n._element),n._tests.push(o),i.setTest(o),n._count--,0===n._count&&n._onReady()}),i},_onReady:function(){var t,e,o=this._tests.length;for(e=0;o>e;e++)t=this._tests[e],t.arrange(),t.assert(),i.subscribe(t,"change",this._onResultsChangedBind);this.test(),i.publish(this,"ready",this._suitable)},_onTestResultsChanged:function(){this.test()},test:function(){var t=this._expression.succeeds();t!=this._suitable&&(this._suitable=t,i.publish(this,"change"))}};var h=function(t,e){if(!t)throw Error('ModuleController(path,options): "path" is a required parameter.');this._path=t,this._options=e||{},this._Module=null,this._moduleInstance=null,this._conditionManager=new l(this._options.conditions,this._options.target),i.subscribe(this._conditionManager,"ready",this._onReady.bind(this)),this._ready=!this.isConditioned()||this._conditionManager.getSuitability(),this._available=!1};h.prototype.isAvailable=function(){return this._available=this._conditionManager.getSuitability(),this._available},h.prototype.isConditioned=function(){return this._options.conditions!==void 0},h.prototype.isReady=function(){return this._ready},h.prototype._onReady=function(t){this._ready=!0,i.subscribe(this._conditionManager,"change",this._onConditionsChange.bind(this)),i.publish(this,"ready"),t&&this._onAvailable()},h.prototype._onAvailable=function(){this._available=!0,i.publish(this,"available",this)},h.prototype._onConditionsChange=function(){var t=this._conditionManager.getSuitability();this._moduleInstance&&!t&&this.unload(),!this._moduleInstance&&t&&this._onAvailable()},h.prototype.load=function(){if(this._Module)return this._onLoad(),void 0;var e=this;t([this._path],function(t){e._Module=t,e._onLoad()})},h.prototype._onLoad=function(){if(this.isAvailable()){var t,o=s.getModuleByPath(this._path),n=o?o.config:{},r={};if("string"==typeof this._options.options)try{r=JSON.parse(this._options.options)}catch(a){throw Error('ModuleController.loadModule(): "options" is not a valid JSON string.')}else r=this._options.options;t=n?e.mergeObjects(n,r):r,this._moduleInstance=new this._Module(this._options.target,t),i.setupPropagationTarget(this._moduleInstance,this),i.publish(this,"load",this)}},h.prototype.unload=function(){return this._available=!1,this._moduleInstance?(i.removePropagationTarget(this._moduleInstance,this),this._moduleInstance._unload&&this._moduleInstance._unload(),this._moduleInstance=null,i.publish(this,"unload",this),!0):!1},h.prototype.matchesQuery=function(t){return"string"==typeof t&&e.matchesSelector(this._options.target,t)?!0:t==this._options.target},h.prototype.execute=function(t,e){if(!this._moduleInstance)return null;var i=this._moduleInstance[t];if(!i)throw Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return i.apply(this._moduleInstance,e)};var c=function(t){this._element=t,this._element.setAttribute("data-processed","true"),this._priority=this._element.getAttribute("data-priority"),this._moduleControllers=[],this._activeModuleController=null,this._activeModuleUnloadBind=this._onActiveModuleUnload.bind(this)};c.hasProcessed=function(t){return"true"===t.getAttribute("data-processed")},c.prototype.getPriority=function(){return this._priority},c.prototype.init=function(){this._moduleControllers=this._getModuleControllers();var t,e,o=this._moduleControllers.length;for(t=0;o>t;t++)e=this._moduleControllers[t],e.isReady()?this._onModuleReady():i.subscribe(e,"ready",this._onModuleReady.bind(this))},c.prototype._onModuleReady=function(){for(var t=0,e=this._moduleControllers.length;e>t;t++)if(!this._moduleControllers[t].isReady())return;this._onModulesReady()},c.prototype._onModulesReady=function(){var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t);for(var e=0,o=this._moduleControllers.length;o>e;e++)i.subscribe(this._moduleControllers[e],"available",this._onModuleAvailable.bind(this))},c.prototype._onModuleAvailable=function(t){for(var e,i=0,o=this._moduleControllers.length;o>i;i++)if(e=this._moduleControllers[i],e!==t&&e.isAvailable()&&e.isConditioned())return;this._setActiveModuleController(t)},c.prototype._setActiveModuleController=function(t){t!==this._activeModuleController&&(this._cleanActiveModuleController(),this._activeModuleController=t,i.subscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.load())},c.prototype._cleanActiveModuleController=function(){this._activeModuleController&&(i.unsubscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.unload(),this._activeModuleController=null)},c.prototype._onActiveModuleUnload=function(){this._cleanActiveModuleController();var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t)},c.prototype._getSuitableActiveModuleController=function(){for(var t,e=0,i=this._moduleControllers.length;i>e;e++)if(t=this._moduleControllers[e],t.isAvailable())return t;return null},c.prototype._getModuleControllers=function(){var t=[],e=this._element.getAttribute("data-module"),i="["==e.charAt(0);if(i){var o;try{o=JSON.parse(e)}catch(n){}if(!o)return[];for(var s,r=o.length,a=0;r>a;a++)s=o[a],t.push(new h(s.path,{conditions:s.conditions,options:s.options,target:this._element}))}else t.push(new h(e,{conditions:this._element.getAttribute("data-conditions"),options:this._element.getAttribute("data-options"),target:this._element}));return t},c.prototype.matchesQuery=function(){return null},c.prototype.execute=function(){return null};var d=function(){this._options={attribute:{module:"data-module",conditions:"data-conditions",options:"data-options",priority:"data-priority"},modules:{}},this._nodes=[]};d.prototype={setOptions:function(t){this._options=e.mergeObjects(this._options,t);var i,o,n,r;for(o in this._options.modules)this._options.modules.hasOwnProperty(o)&&(n=this._options.modules[o],r="string"==typeof n?n:n.alias,i="string"==typeof n?null:n.options||{},s.registerModule(o,i,r))},loadModules:function(t){if(!t)throw Error('Conditioner.loadModules(context): "context" is a required parameter.');var e,i=t.querySelectorAll("["+this._options.attribute.module+"]"),o=i.length,n=0,s=[];if(!i)return[];for(;o>n;n++)e=i[n],c.hasProcessed(e)||s.push(new c(e));for(s.sort(function(t,e){return e.getPriority()-t.getPriority()}),o=s.length,n=0;o>n;n++)s[n].init();return this._nodes=this._nodes.concat(s),s},getModule:function(t){for(var e,i=0,o=this._nodes.length;o>i;i++)if(e=this._nodes[i],e.matchesQuery(t))return e;return null},getModuleAll:function(t){if(t===void 0)return this._nodes.concat();for(var e,i=0,o=this._nodes.length,n=[];o>i;i++)e=this._nodes[i],e.matchesQuery(t)&&n.push(e);return n}};var p;return{Observer:i,TestBase:n,ModuleBase:o,mergeObjects:e.mergeObjects,getInstance:function(){return p||(p=new d),p}}});