// conditioner v0.8.1 - A JavaScript framework for conditionally loading UI classes
// Copyright (c) 2013 Rik Schennink - https://github.com/rikschennink/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(["require"],function(t){"use strict";var e=function(){var t=null,e=document.body;e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector");var o={mergeObjects:function(t,e){var n=Array.isArray(e),i=n&&[]||{};return e=e||{},n?(t=t||[],i=i.concat(t),e.forEach(function(e,o){"object"==typeof e?i[o]=mergeObjects(t[o],e):-1===t.indexOf(e)&&i.push(e)})):(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){i[e]=t[e]}),Object.keys(e).forEach(function(n){i[n]="object"==typeof e[n]&&e[n]?t[n]?o.mergeObjects(t[n],e[n]):e[n]:e[n]})),i},matchesSelector:function(e,o){return e&&t?e[t](o):!1}};return o}(),o={subscribe:function(t,e,o){t._subscriptions||(t._subscriptions=[]);for(var n,i=0,s=t._subscriptions;s>i;i++)if(n=t._subscriptions[i],n.type==e&&n.fn==o)return;t._subscriptions.push({type:e,fn:o})},unsubscribe:function(t,e,o){if(t._subscriptions){var n,i;for(i=t._subscriptions.length-1;i>=0;i--)if(n=t._subscriptions[i],n.type==e&&n.fn==o){t._subscriptions.splice(i,1);break}}},publish:function(t,e,o){t._subscriptions||(t._subscriptions=[]);for(var n,i=[],s=0,r=t._subscriptions.length;r>s;s++)n=t._subscriptions[s],n.type==e&&i.push(n);for(r=i.length,s=0;r>s;s++)i[s].fn(o);t._eventPropagationTarget&&this.publish(t._eventPropagationTarget,e,o)},setupPropagationTarget:function(t,e){return t&&e?(t._eventPropagationTarget=e,!0):!1},removePropagationTarget:function(t,e){return t&&e?t._eventPropagationTarget===e?(t._eventPropagationTarget=null,!0):!1:!1}},n={getExpressionsCount:function(t){return t.match(/(\:\{)/g).length},toExpressionTree:function(t){var e,o,i,s,r,u,l=0,a="",h=[],c="",d=!1,p=null,_=null,f=null,v=[],m=t.length;for(p||(p=h);m>l;l++)if(e=t.charAt(l),"{"!==e)if("}"!==e){if(d)c+=e;else if((" "===e||0===l)&&(u=t.substr(l,5).match(/and |or |not /g),u&&(s=u[0],r=s.length-1,p.push(s.substring(0,r)),l+=r)),"("===e)p.push([]),v.push(p),p=p[p.length-1];else if((")"===e||l===m-1)&&(_=null,f=v.pop(),(1===p.length||f&&1===f.length&&l===m-1)&&(_=p.concat()),p=f,_&&p))for(p.pop(),o=0;_.length>o;o++)p.push(_[o])}else p.push({path:a,value:c}),a="",c="",d=!1;else for(d=!0,a="",o=l-2;o>=0&&(i=t.charAt(o)," "!==i&&"("!==i);)a=i+a,o--;return n._makeExplicit(h),console.log(JSON.stringify(h)),1===h.length?h[0]:h},_makeExplicit:function(t){for(var e=0,o=t.length,i=0;o>e;e++)"object"==typeof t[e]&&i++,2===i&&o>e+1&&(t.splice(0,e+1,t.slice(0,e+1)),o=t.length,e=-1,i=0),t[e]instanceof Array&&n._makeExplicit(t[e])}};window.ExpressionFormatter=n;var i=function(t,o){if(!t)throw Error('BehaviorBase(element,options): "element" is a required parameter.');this._element=t,this._element.setAttribute("data-initialized","true"),this._options=this._options||{},this._options=o?e.mergeObjects(this._options,o):this._options};i.prototype.unload=function(){this._element.removeAttribute("data-initialized")};var s=function(t,e){this._expected=t,this._element=e,this._state=!0};s.inherit=function(){var t=function(t,e){s.call(this,t,e)};return t.prototype=Object.create(s.prototype),t},s.prototype.arrange=function(){},s.prototype.assert=function(){var t=this._onAssert(this._expected);this._state!==t&&(this._state=t,o.publish(this,"change",t))},s.prototype._onAssert=function(){return!1},s.prototype.succeeds=function(){return this._state};var r={_modules:{},registerModule:function(t,e,o){var n,i,s=o||t;this._modules[s]={},e&&(this._modules[s].config=e,i={},i[t]=e,requirejs.config({config:i})),o&&(this._modules[s].alias=o,n={},n[o]=t,requirejs.config({map:{"*":n}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},u={succeeds:function(){}},l=function(t,e){this._expression=t,this._negate=e===void 0?!1:e};l.prototype=Object.create(u),l.prototype.setTest=function(t){this._expression=t},l.prototype.succeeds=function(){return this._expression?this._expression.succeeds()!==this._negate:!1};var a=function(t,e,o){this._a=t,this._o=e,this._b=o};a.prototype=Object.create(u),a.prototype.succeeds=function(){return"and"===this._o?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()};var h=function(t,e){if(this._suitable=!0,"string"==typeof t){this._suitable=!1,this._element=e,this._tests=[],this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=n.getExpressionsCount(t);var o=n.toExpressionTree(t);this._expression=this._loadExpression(o)}};h.prototype={getSuitability:function(){return this._suitable},_loadExpression:function(t){console.log("load:  ",t),t.length},_createUnaryExpressionFromTest:function(e,o){var n=new l(null,o),i=null,s=this;return t(["tests/"+e.path],function(t){i=new t(e.value,s._element),s._tests.push(i),n.setTest(i),s._count--,0===s._count&&s._onReady()}),n},_onReady:function(){var t,e,n=this._tests.length;for(e=0;n>e;e++)t=this._tests[e],t.arrange(),t.assert(),o.subscribe(t,"change",this._onResultsChangedBind);this.test(),o.publish(this,"ready",this._suitable)},_onTestResultsChanged:function(){this.test()},test:function(){var t=this._expression.succeeds();t!=this._suitable&&(this._suitable=t,o.publish(this,"change"))}};var c=function(t,e){if(!t)throw Error('ModuleController(path,options): "path" is a required parameter.');this._path=t,this._options=e||{},this._Module=null,this._moduleInstance=null,this._conditionsManager=new h(this._options.conditions,this._options.target),o.subscribe(this._conditionsManager,"ready",this._onReady.bind(this)),this._ready=!this.isConditioned()||this._conditionsManager.getSuitability(),this._available=!1};c.prototype.isAvailable=function(){return this._available=this._conditionsManager.getSuitability(),this._available},c.prototype.isActive=function(){return null!==this._moduleInstance},c.prototype.isConditioned=function(){return this._options.conditions!==void 0},c.prototype.isReady=function(){return this._ready},c.prototype.matchesPath=function(t){return this._path===t},c.prototype._onReady=function(t){this._ready=!0,o.subscribe(this._conditionsManager,"change",this._onConditionsChange.bind(this)),o.publish(this,"ready"),t&&this._onAvailable()},c.prototype._onAvailable=function(){this._available=!0,o.publish(this,"available",this)},c.prototype._onConditionsChange=function(){var t=this._conditionsManager.getSuitability();this._moduleInstance&&!t&&this.unload(),!this._moduleInstance&&t&&this._onAvailable()},c.prototype.load=function(){if(this._Module)return this._onLoad(),void 0;var e=this;t([this._path],function(t){e._Module=t,e._onLoad()})},c.prototype._onLoad=function(){if(this.isAvailable()){var t,n=r.getModuleByPath(this._path),i=n?n.config:{},s={};if("string"==typeof this._options.options)try{s=JSON.parse(this._options.options)}catch(u){throw Error('ModuleController.loadModule(): "options" is not a valid JSON string.')}else s=this._options.options;t=i?e.mergeObjects(i,s):s,this._moduleInstance=new this._Module(this._options.target,t),o.setupPropagationTarget(this._moduleInstance,this),o.publish(this,"load",this)}},c.prototype.unload=function(){return this._available=!1,this._moduleInstance?(o.removePropagationTarget(this._moduleInstance,this),this._moduleInstance.unload&&this._moduleInstance.unload(),this._moduleInstance=null,o.publish(this,"unload",this),!0):!1},c.prototype.execute=function(t,e){if(!this._moduleInstance)return{status:404,response:null};var o=this._moduleInstance[t];if(!o)throw Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return{status:200,response:o.apply(this._moduleInstance,e)}};var d=function(t){this._element=t,this._element.setAttribute("data-processed","true"),this._priority=this._element.getAttribute("data-priority"),this._moduleControllers=[],this._activeModuleController=null,this._activeModuleUnloadBind=this._onActiveModuleUnload.bind(this)};d.hasProcessed=function(t){return"true"===t.getAttribute("data-processed")},d.prototype.getPriority=function(){return this._priority},d.prototype.init=function(){this._moduleControllers=this._createModuleControllers();for(var t,e=0,n=this._moduleControllers.length;n>e;e++)t=this._moduleControllers[e],t.isReady()?this._onModuleReady():o.subscribe(t,"ready",this._onModuleReady.bind(this))},d.prototype._onModuleReady=function(){for(var t,e=0,o=this._moduleControllers.length;o>e;e++)if(t=this._moduleControllers[e],!t.isReady())return;this._onModulesReady()},d.prototype._onModulesReady=function(){var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t);for(var e=0,n=this._moduleControllers.length;n>e;e++)o.subscribe(this._moduleControllers[e],"available",this._onModuleAvailable.bind(this))},d.prototype._onModuleAvailable=function(t){for(var e,o=0,n=this._moduleControllers.length;n>o;o++)if(e=this._moduleControllers[o],e!==t&&e.isAvailable()&&e.isConditioned())return;this._setActiveModuleController(t)},d.prototype._setActiveModuleController=function(t){t!==this._activeModuleController&&(this._cleanActiveModuleController(),this._activeModuleController=t,o.subscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.load())},d.prototype._cleanActiveModuleController=function(){this._activeModuleController&&(o.unsubscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.unload(),this._activeModuleController=null)},d.prototype._onActiveModuleUnload=function(){this._cleanActiveModuleController();var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t)},d.prototype._getSuitableActiveModuleController=function(){for(var t,e=0,o=this._moduleControllers.length;o>e;e++)if(t=this._moduleControllers[e],t.isAvailable())return t;return null},d.prototype._createModuleControllers=function(){var t=[],e=this._element.getAttribute("data-module"),o="["==e.charAt(0);if(o){var n;try{n=JSON.parse(e)}catch(i){}if(!n)return[];for(var s,r=n.length,u=0;r>u;u++)s=n[u],t.push(new c(s.path,{conditions:s.conditions,options:s.options,target:this._element}))}else t.push(new c(e,{conditions:this._element.getAttribute("data-conditions"),options:this._element.getAttribute("data-options"),target:this._element}));return t},d.prototype.matchesSelector=function(t){return e.matchesSelector(this._element,t)},d.prototype.getActiveModuleController=function(){return this._activeModuleController},d.prototype.getModuleControllerByPath=function(t){return this._filterModuleControllers(t,!0)},d.prototype.getModuleControllerAllByPath=function(t){return this._filterModuleControllers(t,!1)},d.prototype._filterModuleControllers=function(t,e){for(var o,n=0,i=this._moduleControllers.length,s=[];i>n;n++)if(o=this._moduleControllers[n],o.matchesPath(t)){if(e)return o;s.push(o)}return e?null:s},d.prototype.execute=function(t,e){return this._activeModuleController?this._activeModuleController.execute(t,e):{status:404,response:null}};var p=function(){this._options={attribute:{module:"data-module"},modules:{}},this._nodes=[]};p.prototype={setOptions:function(t){this._options=e.mergeObjects(this._options,t);var o,n,i,s;for(n in this._options.modules)this._options.modules.hasOwnProperty(n)&&(i=this._options.modules[n],s="string"==typeof i?i:i.alias,o="string"==typeof i?null:i.options||{},r.registerModule(n,o,s))},loadModules:function(t){if(!t)throw Error('Conditioner.loadModules(context): "context" is a required parameter.');var e,o=t.querySelectorAll("["+this._options.attribute.module+"]"),n=o.length,i=0,s=[];if(!o)return[];for(;n>i;i++)e=o[i],d.hasProcessed(e)||s.push(new d(e));for(s.sort(function(t,e){return e.getPriority()-t.getPriority()}),n=s.length,i=0;n>i;i++)s[i].init();return this._nodes=this._nodes.concat(s),s},getNode:function(t){return this._filterNodes(t,!0)},getNodesAll:function(t){return this._filterNodes(t,!1)},_filterNodes:function(t,e){if(t===void 0)return e?null:[];for(var o,n=0,i=this._nodes.length,s=[];i>n;n++)if(o=this._nodes[n],o.matchesSelector(t)){if(e)return o;s.push(o)}return e?null:s}};var _;return{Observer:o,TestBase:s,ModuleBase:i,mergeObjects:e.mergeObjects,getInstance:function(){return _||(_=new p),_}}});