// conditioner v0.8.1 - A JavaScript framework for conditionally loading UI classes
// Copyright (c) 2013 Rik Schennink - https://github.com/rikschennink/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(["require"],function(t){"use strict";function e(t,n){var i=Array.isArray(n),o=i&&[]||{};return n=n||{},i?(t=t||[],o=o.concat(t),n.forEach(function(n,i){"object"==typeof n?o[i]=e(t[i],n):-1===t.indexOf(n)&&o.push(n)})):(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){o[e]=t[e]}),Object.keys(n).forEach(function(i){o[i]="object"==typeof n[i]&&n[i]?t[i]?e(t[i],n[i]):n[i]:n[i]})),o}var n=function(){var t=null,e=document.body;return e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector"),function(e,n){return e?e[t](n):!1}}(),i=function(){return{subscribe:function(t,e,n){t._subscriptions||(t._subscriptions=[]);for(var i,o=0,s=t._subscriptions;s>o;o++)if(i=t._subscriptions[o],i.type==e&&i.fn==n)return;t._subscriptions.push({type:e,fn:n})},unsubscribe:function(t,e,n){if(t._subscriptions){var i,o;for(o=t._subscriptions.length-1;o>=0;o--)if(i=t._subscriptions[o],i.type==e&&i.fn==n){t._subscriptions.splice(o,1);break}}},publish:function(t,e,n){t._subscriptions||(t._subscriptions=[]);for(var i,o=[],s=0,r=t._subscriptions.length;r>s;s++)i=t._subscriptions[s],i.type==e&&o.push(i);for(r=o.length,s=0;r>s;s++)o[s].fn(n);t._eventPropagationTarget&&this.publish(t._eventPropagationTarget,e,n)},setupPropagationTarget:function(t,e){t&&(t._eventPropagationTarget=e)},removePropagationTarget:function(t){t&&(t._eventPropagationTarget=null)}}}(),o=function(t){var e=function(e,n){if(!e)throw Error('BehaviorBase(element,options): "element" is a required parameter.');this._element=e,this._element.setAttribute("data-initialized","true"),this._options=this._options||{},this._options=n?t(this._options,n):this._options};return e.prototype._unload=function(){this._element.removeAttribute("data-initialized")},e}(e),s=function(t){var e=function(t,e){this._expected=t,this._element=e,this._state=!0};e.inherit=function(){var t=function(t,n){e.call(this,t,n)};return t.prototype=Object.create(e.prototype),t};var n=e.prototype;return n._test=function(){},n.arrange=function(){},n.assert=function(){var e=this._test(this._expected);this._state!==e&&(this._state=e,t.publish(this,"change",e))},n.succeeds=function(){return this._state},e}(i),r={_modules:{},registerModule:function(t,e,n){var i,o,s=n||t;this._modules[s]={},e&&(this._modules[s].config=e,o={},o[t]=e,requirejs.config({config:o})),n&&(this._modules[s].alias=n,i={},i[n]=t,requirejs.config({map:{"*":i}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},u=function(t){var e=function(t){for(var n=0,i=t.length;i>n;n++)i>3?(t.splice(n,3,t.slice(n,n+3)),i=t.length,n=-1):"string"!=typeof t[n]&&e(t[n])},n=function(t){var n,i,o,s,r=0,u="",a=[],l="",h=!1,c=null,d=null,_=null,p=[],f=t.length;for(c||(c=a);f>r;r++)if(n=t.charAt(r),"{"!==n)if("}"!==n)if(h)l+=n;else if(" "!==n){if("("===n)c.push([]),p.push(c),c=c[c.length-1];else if((")"===n||r===f-1)&&(d=null,_=p.pop(),(1===c.length||_&&1===_.length&&r===f-1)&&(d=c.concat()),c=_,d&&c))for(c.pop(),i=0;d.length>i;i++)c.push(d[i])}else s=t.substr(r,4).match(/and|or/g),s&&(c.push(s[0]),r+=s[0].length+1);else c.push({path:u,value:l}),u="",l="",h=!1;else for(h=!0,u="",i=r-2;i>=0&&(o=t.charAt(i)," "!==o&&"("!==o);)u=o+u,i--;return e(a),1===a.length?a[0]:a},o={succeeds:function(){}},s=function(t){this._test=t};s.prototype=Object.create(o),s.prototype.setTest=function(t){this._test=t},s.prototype.succeeds=function(){return this._test.succeeds()};var r=function(t,e,n){this._a=t,this._o=e,this._b=n};r.prototype=Object.create(o),r.prototype.succeeds=function(){return"and"===this._o?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()};var u=function(t,e){if(this._suitable=!0,"string"==typeof t){this._suitable=!1,this._element=e,this._tests=[],this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=t.match(/(\:\{)/g).length;var i=n(t);console.log(i),this._expression=this._loadExpression(i)}};return u.prototype={getSuitability:function(){return this._suitable},_loadExpression:function(t){return 3===t.length?new r(this._loadExpression(t[0]),t[1],this._loadExpression(t[2])):this._createUnaryExpressionFromTest(t)},_createUnaryExpressionFromTest:function(e){var n=new s(null),i=null,o=this;return t(["tests/"+e.path],function(t){i=new t(e.value,o._element),o._tests.push(i),n.setTest(i),o._count--,0===o._count&&o._onReady()}),n},_onReady:function(){var t,e,n=this._tests.length;for(e=0;n>e;e++)t=this._tests[e],t.arrange(),t.assert(),i.subscribe(t,"change",this._onResultsChangedBind);this.test(),i.publish(this,"ready",this._suitable)},_onTestResultsChanged:function(){this.test()},test:function(){var t=this._expression.succeeds();t!=this._suitable&&(this._suitable=t,i.publish(this,"change"))}},u}(t),a=function(t,e,n,o,s){var r=function(t,e){if(!t)throw Error('ModuleController(path,options): "path" is a required parameter.');this._path=t,this._options=e||{},this._Module=null,this._moduleInstance=null,this._conditionManager=new n(this._options.conditions,this._options.target),i.subscribe(this._conditionManager,"ready",this._onReady.bind(this)),this._ready=!this.isConditioned()||this._conditionManager.getSuitability(),this._available=!1},u=r.prototype;return u.isAvailable=function(){return this._available=this._conditionManager.getSuitability(),this._available},u.isConditioned=function(){return this._options.conditions!==void 0},u.isReady=function(){return this._ready},u._onReady=function(t){this._ready=!0,i.subscribe(this._conditionManager,"change",this._onConditionsChange.bind(this)),i.publish(this,"ready"),t&&this._onAvailable()},u._onAvailable=function(){this._available=!0,i.publish(this,"available",this)},u._onConditionsChange=function(){var t=this._conditionManager.getSuitability();this._moduleInstance&&!t&&this.unload(),!this._moduleInstance&&t&&this._onAvailable()},u.load=function(){if(this._Module)return this._onLoad(),void 0;var e=this;t([this._path],function(t){e._Module=t,e._onLoad()})},u._onLoad=function(){if(this.isAvailable()){var t,n=e.getModuleByPath(this._path),o=n?n.config:{},r={};if("string"==typeof this._options.options)try{r=JSON.parse(this._options.options)}catch(u){throw Error('ModuleController.loadModule(): "options" is not a valid JSON string.')}else r=this._options.options;t=o?s(o,r):r,this._moduleInstance=new this._Module(this._options.target,t),i.setupPropagationTarget(this._moduleInstance,this),i.publish(this,"load",this)}},u.unload=function(){return this._available=!1,this._moduleInstance?(i.removePropagationTarget(this._moduleInstance,this),this._moduleInstance._unload&&this._moduleInstance._unload(),this._moduleInstance=null,i.publish(this,"unload",this),!0):!1},u.matchesQuery=function(t){return"string"==typeof t&&o(this._options.target,t)?!0:t==this._options.target},u.execute=function(t,e){if(!this._moduleInstance)return null;var n=this._moduleInstance[t];if(!n)throw Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return n.apply(this._moduleInstance,e)},r}(t,r,u,n,e),l=function(t){var e=function(t){this._element=t,this._element.setAttribute("data-processed","true"),this._priority=this._element.getAttribute("data-priority"),this._moduleControllers=[],this._activeModuleController=null,this._activeModuleUnloadBind=this._onActiveModuleUnload.bind(this)},n=e.prototype;return e.hasProcessed=function(t){return"true"===t.getAttribute("data-processed")},n.getPriority=function(){return this._priority},n.init=function(){this._moduleControllers=this._getModuleControllers();var e,n,i=this._moduleControllers.length;for(e=0;i>e;e++)n=this._moduleControllers[e],n.isReady()?this._onModuleReady():t.subscribe(n,"ready",this._onModuleReady.bind(this))},n._onModuleReady=function(){for(var t=0,e=this._moduleControllers.length;e>t;t++)if(!this._moduleControllers[t].isReady())return;this._onModulesReady()},n._onModulesReady=function(){var e=this._getSuitableActiveModuleController();e&&this._setActiveModuleController(e);for(var n=0,i=this._moduleControllers.length;i>n;n++)t.subscribe(this._moduleControllers[n],"available",this._onModuleAvailable.bind(this))},n._onModuleAvailable=function(t){for(var e,n=0,i=this._moduleControllers.length;i>n;n++)if(e=this._moduleControllers[n],e!==t&&e.isAvailable()&&e.isConditioned())return;this._setActiveModuleController(t)},n._setActiveModuleController=function(e){e!==this._activeModuleController&&(this._cleanActiveModuleController(),this._activeModuleController=e,t.subscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.load())},n._cleanActiveModuleController=function(){this._activeModuleController&&(t.unsubscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.unload(),this._activeModuleController=null)},n._onActiveModuleUnload=function(){this._cleanActiveModuleController();var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t)},n._getSuitableActiveModuleController=function(){for(var t,e=0,n=this._moduleControllers.length;n>e;e++)if(t=this._moduleControllers[e],t.isAvailable())return t;return null},n._getModuleControllers=function(){var t=[],e=this._element.getAttribute("data-module"),n="["==e.charAt(0);if(n){var i;try{i=JSON.parse(e)}catch(o){}if(!i)return[];for(var s,r=i.length,u=0;r>u;u++)s=i[u],t.push(new a(s.path,{conditions:s.conditions,options:s.options,target:this._element}))}else t.push(new a(e,{conditions:this._element.getAttribute("data-conditions"),options:this._element.getAttribute("data-options"),target:this._element}));return t},n.matchesQuery=function(){return null},n.execute=function(){return null},e}(i),h=function(t,e,n,i,o,s,r){var u=function(){this._options={attribute:{module:"data-module",conditions:"data-conditions",options:"data-options",priority:"data-priority"},modules:{}},this._nodes=[]},a=u.prototype;a.setOptions=function(e){this._options=r(this._options,e);var n,i,o,s;for(i in this._options.modules)this._options.modules.hasOwnProperty(i)&&(o=this._options.modules[i],s="string"==typeof o?o:o.alias,n="string"==typeof o?null:o.options||{},t.registerModule(i,n,s))},a.loadModules=function(t){if(!t)throw Error('Conditioner.loadModules(context): "context" is a required parameter.');var e,i=t.querySelectorAll("["+this._options.attribute.module+"]"),o=i.length,s=0,r=[];if(!i)return[];for(;o>s;s++)e=i[s],n.hasProcessed(e)||r.push(new n(e));for(r.sort(function(t,e){return e.getPriority()-t.getPriority()}),o=r.length,s=0;o>s;s++)r[s].init();return this._nodes=this._nodes.concat(r),r},a.getModule=function(t){for(var e,n=0,i=this._nodes.length;i>n;n++)if(e=this._nodes[n],e.matchesQuery(t))return e;return null},a.getModuleAll=function(t){if(t===void 0)return this._nodes.concat();for(var e,n=0,i=this._node.length,o=[];i>n;n++)e=this._nodes[n],e.matchesQuery(t)&&o.push(e);return o};var l;return{getInstance:function(){return l||(l=new u),l},Test:i,Module:o,Observer:s,mergeObjects:r}}(r,a,l,s,o,i,e);return h});