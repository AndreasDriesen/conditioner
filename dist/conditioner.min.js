// conditioner v0.8.1 - A JavaScript framework for conditionally loading UI classes
// Copyright (c) 2013 Rik Schennink - https://github.com/rikschennink/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(["require"],function(t){"use strict";function e(t,i){var o=Array.isArray(i),n=o&&[]||{};return i=i||{},o?(t=t||[],n=n.concat(t),i.forEach(function(i,o){"object"==typeof i?n[o]=e(t[o],i):-1===t.indexOf(i)&&n.push(i)})):(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(i).forEach(function(o){n[o]="object"==typeof i[o]&&i[o]?t[o]?e(t[o],i[o]):i[o]:i[o]})),n}var i=function(){var t=null,e=document.body;return e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector"),function(e,i){return e?e[t](i):!1}}(),o=function(){return{subscribe:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var o,n=0,s=t._subscriptions;s>n;n++)if(o=t._subscriptions[n],o.type==e&&o.fn==i)return;t._subscriptions.push({type:e,fn:i})},unsubscribe:function(t,e,i){if(t._subscriptions){var o,n;for(n=t._subscriptions.length-1;n>=0;n--)if(o=t._subscriptions[n],o.type==e&&o.fn==i){t._subscriptions.splice(n,1);break}}},publish:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var o,n=0,s=t._subscriptions.length;s>n;n++)o=t._subscriptions[n],o.type==e&&o.fn(i);t._eventPropagationTarget&&this.publish(t._eventPropagationTarget,e,i)},setupPropagationTarget:function(t,e){t&&(t._eventPropagationTarget=e)}}}(),n=function(t){var e=function(e,i){if(!e)throw Error('BehaviorBase(element,options): "element" is a required parameter.');this._element=e,this._element.setAttribute("data-initialized","true"),this._options=this._options||{},this._options=i?t(this._options,i):this._options};return e.prototype._unload=function(){this._element.removeAttribute("data-initialized")},e}(e),s=function(t){var e=function(t,e){if(this._element=e,this._state=!0,this._rules=[],t instanceof Array||"object"!=typeof t)this._addRule(t);else if("object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&this._addRule(t[i],i)};e.inherit=function(){var t=function(t,i){e.call(this,t,i)};return t.prototype=Object.create(e.prototype),t};var i=e.prototype;return i._addRule=function(t,e){if(!t)throw Error('TestBase._addRule(value,key): "value" is a required parameter.');this._rules.push({key:e===void 0?"default":e,value:t})},i._test=function(){},i.arrange=function(){},i.assert=function(){for(var e=0,i=this._rules.length,o=!0;i>e;e++)if(!this._test(this._rules[e])){o=!1;break}this._state!=o&&(this._state=o,t.publish(this,"change",o))},i.succeeds=function(){return this._state},e}(o),r={_modules:{},registerModule:function(t,e,i){var o,n,s=i||t;this._modules[s]={},e&&(this._modules[s].config=e,n={},n[t]=e,requirejs.config({config:n})),i&&(this._modules[s].alias=i,o={},o[i]=t,requirejs.config({map:{"*":o}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},u=function(t){var e=function(t,e){if(this._suitable=!0,t){if(this._suitable=!1,"string"==typeof t)try{t=JSON.parse(t)}catch(i){return console.warn("ConditionManager(expected,element): expected conditions should be in JSON format."),void 0}this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._tests=[],this._count=0;var o;for(o in t)t.hasOwnProperty(o)&&(this._count++,this._loadTest(o,t,e))}};return e.prototype={_loadTest:function(e,i,o){var n=this;t(["tests/"+e],function(t){var s=new t(i[e],o);n._tests.push(s),n._onLoadTest()})},_onLoadTest:function(){this._count--,0==this._count&&this._onReady()},_onReady:function(){var t,e,i=this._tests.length;for(e=0;i>e;e++)t=this._tests[e],t.arrange(),t.assert(),o.subscribe(t,"change",this._onResultsChangedBind);this.test()},_onTestResultsChanged:function(){this.test()},test:function(){var t,e,i=!0,n=this._tests.length;for(e=0;n>e;e++)if(t=this._tests[e],!t.succeeds()){i=!1;break}i!=this._suitable&&(this._suitable=i,o.publish(this,"change"))},getSuitability:function(){return this._suitable}},e}(t),a=function(t,e,i,n,s){var r=function(t,e){if(!t)throw Error('ModuleController(path,options): "path" is a required parameter.');this._path=t,this._options=e||{},this._options.suitable=this._options.suitable===void 0?!0:this._options.suitable,this._module=null},u=r.prototype;return u.init=function(){this._conditionManager=new i(this._options.conditions,this._options.target),o.subscribe(this._conditionManager,"change",this._onConditionsChange.bind(this)),this._conditionManager.getSuitability()===this._options.suitable&&this._loadModule()},u._onConditionsChange=function(){var t=this._conditionManager.getSuitability();this._module&&t!==this._options.suitable&&this.unloadModule(),this._module||t!==this._options.suitable||this._loadModule()},u._loadModule=function(){var i=this;t([this._path],function(t){var n,r=e.getModuleByPath(i._path),u=r?r.config:{},a={};if("string"==typeof i._options.options)try{a=JSON.parse(i._options.options)}catch(h){}else a=i._options.options;n=u?s(u,a):a,i._module=new t(i._options.target,n),o.setupPropagationTarget(i._module,i)})},u.unloadModule=function(){return this._module?(this._module._unload&&this._module._unload(),this._module=null,!0):!1},u.matchesQuery=function(t){return"string"==typeof t&&n(this._options.target,t)?!0:t==this._options.target},u.execute=function(t,e){if(!this._module)return null;var i=this._module[t];if(!i)throw Error('Conditioner(method,params): "method" not found on module.');return i.apply(this._module,e)},r}(t,r,u,i,e),h=function(t,e,i,o,n,s){var r=function(){this._options={attribute:{module:"data-module",alternative:"data-module-alt",conditions:"data-conditions",options:"data-options","options-alt":"data-options-alt",priority:"data-priority"},modules:{}},this._controllers=[]},u=r.prototype;u.setOptions=function(e){this._options=i(this._options,e);var o,n,s,r;for(n in this._options.modules)this._options.modules.hasOwnProperty(n)&&(s=this._options.modules[n],r="string"==typeof s?s:s.alias,o="string"==typeof s?null:s.options||{},t.registerModule(n,o,r))},u.applyBehavior=function(t){if(!t)throw Error('Conditioner.applyBehavior(context,options): "context" is a required parameter.');var i,o,n,s,r=t.querySelectorAll("["+this._options.attribute.module+"]"),u=0,a=r.length,h=[],c=[];if(!r)return[];for(;a>u;u++)if(o=r[u],"true"!=o.getAttribute("data-processed"))for(o.setAttribute("data-processed","true"),n=this._getModuleSpecificationsByElement(o);s=n.shift();)i=new e(s.path,{target:o,conditions:s.conditions,options:s.options,suitable:s.suitable}),c.push({controller:i,priority:s.priority}),h.push(i);for(c.sort(function(t,e){return e.priority-t.priority}),a=h.length,u=0;a>u;u++)c[u].controller.init();return this._controllers=this._controllers.concat(h),h},u._getModuleSpecificationsByElement=function(t){var e,i,o=t.getAttribute(this._options.attribute.module),n="["===o.charAt(0),s=[];if(n){e=this._getElementAttributeAsObject(t,this._options.attribute.conditions);for(var r=this._getElementAttributeAsObject(t,this._options.attribute.module),u=this._getElementAttributeAsObject(t,this._options.attribute.options),a=this._getElementAttributeAsObject(t,this._options.attribute.priority),h=r.length,c=0;h>c;c++)s.push({path:r[c],conditions:e.length?e[c]:e,options:u.length?u[c]:u,priority:a.length?a[c]:a,suitable:!0})}else e=t.getAttribute(this._options.attribute.conditions),s.push({path:o,conditions:e,options:t.getAttribute(this._options.attribute.options),priority:t.getAttribute(this._options.attribute.priority),suitable:!0}),i=t.getAttribute(this._options.attribute.alternative);return i&&s.push({path:i,conditions:e,options:null,priority:t.getAttribute(this._options.attribute.priority),suitable:!1}),s},u._getElementAttributeAsObject=function(t,e){var i=t.getAttribute(e);if(i)try{return JSON.parse(i)}catch(o){}return[i]},u.getModule=function(t){for(var e,i=0,o=this._controllers.length;o>i;i++)if(e=this._controllers[i],e.matchesQuery(t))return e;return null},u.getModuleAll=function(t){if(t===void 0)return this._controllers.concat();for(var e,i=0,o=this._controllers.length,n=[];o>i;i++)e=this._controllers[i],e.matchesQuery(t)&&n.push(e);return n};var a;return{getInstance:function(){return a||(a=new r),a},Test:o,Module:n,Observer:s,mergeObjects:i}}(r,a,e,s,n,o);return h});