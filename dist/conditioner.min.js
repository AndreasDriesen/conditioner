// conditioner v0.8.5 - Conditioner, detangles your javascript and makes it shine.
// Copyright (c) 2013 Rik Schennink - https://github.com/rikschennink/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(["require"],function(t){"use strict";var e=function(){var t=null,e=document.body;e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector");var o={mergeObjects:function(t,e){var i=Array.isArray(e),n=i&&[]||{};return e=e||{},i?(t=t||[],n=n.concat(t),e.forEach(function(e,i){"object"==typeof e?n[i]=o.mergeObjects(t[i],e):-1===t.indexOf(e)&&n.push(e)})):(t&&"object"==typeof t&&Object.keys(t).forEach(function(e){n[e]=t[e]}),Object.keys(e).forEach(function(i){n[i]="object"==typeof e[i]&&e[i]?t[i]?o.mergeObjects(t[i],e[i]):e[i]:e[i]})),n},matchesSelector:function(e,o){return e&&t?e[t](o):!1}};return o}(),o={subscribe:function(t,e,o){t._subscriptions||(t._subscriptions=[]);for(var i,n=0,s=t._subscriptions;s>n;n++)if(i=t._subscriptions[n],i.type===e&&i.fn===o)return;t._subscriptions.push({type:e,fn:o})},unsubscribe:function(t,e,o){if(t._subscriptions)for(var i,n=t._subscriptions.length;--n>=0;)if(i=t._subscriptions[n],i.type===e&&i.fn===o){t._subscriptions.splice(n,1);break}},publish:function(t,e,o){t._subscriptions||(t._subscriptions=[]);for(var i,n=[],s=0,r=t._subscriptions.length;r>s;s++)i=t._subscriptions[s],i.type===e&&n.push(i);for(r=n.length,s=0;r>s;s++)n[s].fn(o);t._eventPropagationTarget&&this.publish(t._eventPropagationTarget,e,o)},setupPropagationTarget:function(t,e){return t&&e?(t._eventPropagationTarget=e,!0):!1},removePropagationTarget:function(t,e){return t&&e?t._eventPropagationTarget===e?(t._eventPropagationTarget=null,!0):!1:!1}},i=function(){};i.prototype={succeeds:function(){},getConfig:function(){}};var n=function(t,e){this._expression=t instanceof s||t instanceof n?t:null,this._config=this._expression?null:t,this._negate=e===void 0?!1:e};n.prototype=Object.create(i),n.prototype.assignTester=function(t){this._expression=t},n.prototype.getConfig=function(){return this._config?[{expression:this,config:this._config}]:this._expression.getConfig()},n.prototype.succeeds=function(){return this._expression.succeeds?this._expression.succeeds()!==this._negate:!1},n.prototype.toString=function(){return(this._negate?"not ":"")+(this._expression?""+this._expression:this._config.path+":{"+this._config.value+"}")};var s=function(t,e,o){this._a=t,this._o=e,this._b=o};s.prototype=Object.create(i),s.prototype.succeeds=function(){return"and"===this._o?this._a.succeeds()&&this._b.succeeds():this._a.succeeds()||this._b.succeeds()},s.prototype.toString=function(){return"("+(""+this._a)+" "+this._o+" "+(""+this._b)+")"},s.prototype.getConfig=function(){return[this._a.getConfig(),this._b.getConfig()]};var r={getExpressionsCount:function(t){return t.match(/(\:\{)/g).length},fromString:function(t){var e,o,i,r,u,a,l,h,c,d,p=0,_="",f=[],m="",g=!1,v=!1,b=null,y=null,M=[],C=t.length;for(b||(b=f);C>p;p++)if(u=t.charAt(p),"{"!==u)if("}"===u&&(e=b.length-1,o=e+1,g="not"===b[e],o=g?e:e+1,b[o]=new n({path:_,value:m},g),_="",m="",g=!1,v=!1),v)m+=u;else{if("("===u&&(b.push([]),M.push(b),b=b[b.length-1])," "===u||0===p||"("===u){if(i=t.substr(p,5).match(/and |or |not /g),!i)continue;h=i[0],c=h.length-1,b.push(h.substring(0,c)),p+=c}if(")"===u||p===C-1)do if(y=M.pop(),0!==b.length){for(r=0,d=b.length;d>r;r++)"string"==typeof b[r]&&("not"===b[r]?(b.splice(r,2,new n(b[r+1],!0)),r=-1,d=b.length):"not"!==b[r+1]&&(b.splice(r-1,3,new s(b[r-1],b[r],b[r+1])),r=-1,d=b.length));1===b.length&&y&&(y[y.length-1]=b[0],b=y)}else b=y;while(p===C-1&&y)}else for(v=!0,_="",a=p-2;a>=0&&(l=t.charAt(a)," "!==l&&"("!==l);)_=l+_,a--;return 1===f.length?f[0]:f}},u=function(){this._memory={}};u.prototype={remember:function(t,e){return e===void 0?this._memory[t]:(this._memory[t]=e,e)},handleEvent:function(t){this.act(t)},arrange:function(){},act:function(){o.publish(this,"change")},assert:function(){}};var a={_register:[],_addTest:function(t,e){var o=function(){u.call(this)};o.prototype=Object.create(u.prototype),e.assert&&(o.prototype.assert=e.assert),e.act&&(o.prototype.act=e.act),e.arrange&&(o.prototype.arrange=e.arrange);var i=new o;return i.arrange(),this._register[t]=i,i},getTest:function(e,o){e="tests/"+e,t([e],function(t){var i=a._register[e];i||(i=a._addTest(e,t)),o(i)})}},l=function(t,e,i){this._result=null,this._test=t,this._expected=e,this._element=i,o.subscribe(this._test,"change",this._onChange.bind(this))};l.prototype._onChange=function(){this._result=null},l.prototype.succeeds=function(){return null===this._result&&(this._result=this._test.assert(this._expected,this._element)),this._result};var h=function(t,o){if(!t)throw Error('ModuleBase(element,options): "element" is a required parameter.');this._element=t,this._element.setAttribute("data-initialized","true"),this._options=this._options||{},this._options=o?e.mergeObjects(this._options,o):this._options};h.prototype.unload=function(){this._element.removeAttribute("data-initialized")};var c={_modules:{},registerModule:function(t,e,o){var i,n,s=o||t;this._modules[s]={},e&&(this._modules[s].config=e,n={},n[t]=e,requirejs.config({config:n})),o&&(this._modules[s].alias=o,i={},i[o]=t,requirejs.config({map:{"*":i}}))},getModuleByPath:function(t){if(!t)throw Error('ModuleRegister.getModuleById(path): "path" is a required parameter.');return this._modules[t]}},d=function(t,e){this._suitable=!0,"string"==typeof t&&(this._suitable=!1,this._element=e,this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._count=r.getExpressionsCount(t),this._expression=r.fromString(t),this._loadExpressionTests(this._expression.getConfig()))};d.prototype={getSuitability:function(){return this._suitable},test:function(){var t=this._expression.succeeds();t!=this._suitable&&(this._suitable=t,o.publish(this,"change"))},_loadExpressionTests:function(t){for(var e=0;t.length>e;e++)Array.isArray(t[e])?this._loadExpressionTests(t[e]):this._loadTesterToExpression(t[e].config,t[e].expression)},_loadTesterToExpression:function(t,e){var i=this;a.getTest(t.path,function(n){e.assignTester(new l(n,t.value,i._element)),o.subscribe(n,"change",i._onResultsChangedBind),i._count--,0===i._count&&i._onReady()})},_onReady:function(){this.test(),o.publish(this,"ready",this._suitable)},_onTestResultsChanged:function(){this.test()}};var p=function(t,e){if(!t)throw Error('ModuleController(path,options): "path" is a required parameter.');this._path=t,this._options=e||{},this._Module=null,this._moduleInstance=null,this._conditionsManager=new d(this._options.conditions,this._options.target),o.subscribe(this._conditionsManager,"ready",this._onReady.bind(this)),this._ready=!this.isConditioned()||this._conditionsManager.getSuitability(),this._available=!1};p.prototype.isAvailable=function(){return this._available=this._conditionsManager.getSuitability(),this._available},p.prototype.isActive=function(){return null!==this._moduleInstance},p.prototype.isConditioned=function(){return this._options.conditions!==void 0},p.prototype.isReady=function(){return this._ready},p.prototype.matchesPath=function(t){return this._path===t},p.prototype._onReady=function(t){this._ready=!0,o.subscribe(this._conditionsManager,"change",this._onConditionsChange.bind(this)),o.publish(this,"ready"),t&&this._onAvailable()},p.prototype._onAvailable=function(){this._available=!0,o.publish(this,"available",this)},p.prototype._onConditionsChange=function(){var t=this._conditionsManager.getSuitability();this._moduleInstance&&!t&&this.unload(),!this._moduleInstance&&t&&this._onAvailable()},p.prototype.load=function(){if(this._Module)return this._onLoad(),void 0;var e=this;t([this._path],function(t){e._Module=t,e._onLoad()})},p.prototype._onLoad=function(){if(this.isAvailable()){var t,i=c.getModuleByPath(this._path),n=i?i.config:{},s={};if("string"==typeof this._options.options)try{s=JSON.parse(this._options.options)}catch(r){throw Error('ModuleController.loadModule(): "options" is not a valid JSON string.')}else s=this._options.options;t=n?e.mergeObjects(n,s):s,this._moduleInstance=new this._Module(this._options.target,t),o.setupPropagationTarget(this._moduleInstance,this),o.publish(this,"load",this)}},p.prototype.unload=function(){return this._available=!1,this._moduleInstance?(o.removePropagationTarget(this._moduleInstance,this),this._moduleInstance.unload&&this._moduleInstance.unload(),this._moduleInstance=null,o.publish(this,"unload",this),!0):!1},p.prototype.execute=function(t,e){if(!this._moduleInstance)return{status:404,response:null};var o=this._moduleInstance[t];if(!o)throw Error('ModuleController.execute(method,params): function specified in "method" not found on module.');return{status:200,response:o.apply(this._moduleInstance,e)}};var _=function(t){if(!t)throw Error('Node(element): "element" is a required parameter.');this._element=t,this._element.setAttribute("data-processed","true"),this._priority=this._element.getAttribute("data-priority"),this._moduleControllers=[],this._activeModuleController=null,this._activeModuleUnloadBind=this._onActiveModuleUnload.bind(this)};_.hasProcessed=function(t){return"true"===t.getAttribute("data-processed")},_.prototype.getPriority=function(){return this._priority},_.prototype.init=function(){this._moduleControllers=this._createModuleControllers();var t,e=0,i=this._moduleControllers.length;if(!i)throw Error('Node.init(): "element" has to have a "data-module" attribute containing a reference to a Module.');for(;i>e;e++)t=this._moduleControllers[e],t.isReady()?this._onModuleReady():o.subscribe(t,"ready",this._onModuleReady.bind(this))},_.prototype._onModuleReady=function(){for(var t=this._moduleControllers.length;--t>=0;)if(!this._moduleControllers[t].isReady())return;this._onModulesReady()},_.prototype._onModulesReady=function(){var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t);for(var e=0,i=this._moduleControllers.length;i>e;e++)o.subscribe(this._moduleControllers[e],"available",this._onModuleAvailable.bind(this))},_.prototype._onModuleAvailable=function(t){for(var e,o=0,i=this._moduleControllers.length;i>o;o++)if(e=this._moduleControllers[o],e!==t&&e.isAvailable()&&e.isConditioned())return;this._setActiveModuleController(t)},_.prototype._setActiveModuleController=function(t){t!==this._activeModuleController&&(this._cleanActiveModuleController(),this._activeModuleController=t,o.subscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.load())},_.prototype._cleanActiveModuleController=function(){this._activeModuleController&&(o.unsubscribe(this._activeModuleController,"unload",this._activeModuleUnloadBind),this._activeModuleController.unload(),this._activeModuleController=null)},_.prototype._onActiveModuleUnload=function(){this._cleanActiveModuleController();var t=this._getSuitableActiveModuleController();t&&this._setActiveModuleController(t)},_.prototype._getSuitableActiveModuleController=function(){for(var t,e=0,o=this._moduleControllers.length;o>e;e++)if(t=this._moduleControllers[e],t.isAvailable())return t;return null},_.prototype._createModuleControllers=function(){var t=[],e=this._element.getAttribute("data-module")||"",o="["===e.charAt(0);if(o){var i;try{i=JSON.parse(e)}catch(n){}if(!i)return[];for(var s,r=i.length,u=0;r>u;u++)s=i[u],t.push(new p(s.path,{conditions:s.conditions,options:s.options,target:this._element}))}else e.length&&t.push(new p(e,{conditions:this._element.getAttribute("data-conditions"),options:this._element.getAttribute("data-options"),target:this._element}));return t},_.prototype.matchesSelector=function(t){return e.matchesSelector(this._element,t)},_.prototype.getActiveModuleController=function(){return this._activeModuleController},_.prototype.getModuleControllerByPath=function(t){return this._filterModuleControllers(t,!0)},_.prototype.getModuleControllerAllByPath=function(t){return this._filterModuleControllers(t,!1)},_.prototype._filterModuleControllers=function(t,e){for(var o,i=0,n=this._moduleControllers.length,s=[];n>i;i++)if(o=this._moduleControllers[i],o.matchesPath(t)){if(e)return o;s.push(o)}return e?null:s},_.prototype.execute=function(t,e){return this._activeModuleController?this._activeModuleController.execute(t,e):{status:404,response:null}};var f=function(){this._options={modules:{}},this._nodes=[],this.Observer=o,this.ModuleBase=h,this.mergeObjects=e.mergeObjects};return f.prototype={setOptions:function(t){this._options=e.mergeObjects(this._options,t);var o,i,n,s;for(i in this._options.modules)this._options.modules.hasOwnProperty(i)&&(n=this._options.modules[i],s="string"==typeof n?n:n.alias,o="string"==typeof n?null:n.options||{},c.registerModule(i,o,s))},loadModules:function(t){if(!t)throw Error('Conditioner.loadModules(context): "context" is a required parameter.');var e,o=t.querySelectorAll("[data-module]"),i=o.length,n=0,s=[];if(!o)return[];for(;i>n;n++)e=o[n],_.hasProcessed(e)||s.push(new _(e));for(s.sort(function(t,e){return t.getPriority()-e.getPriority()}),n=s.length;--n>=0;)s[n].init();return this._nodes=this._nodes.concat(s),s},getNode:function(t){return this._filterNodes(t,!0)},getNodesAll:function(t){return this._filterNodes(t,!1)},_filterNodes:function(t,e){if(t===void 0)return e?null:[];for(var o,i=0,n=this._nodes.length,s=[];n>i;i++)if(o=this._nodes[i],o.matchesSelector(t)){if(e)return o;s.push(o)}return e?null:s}},new f});