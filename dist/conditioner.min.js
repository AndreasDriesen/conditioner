// conditioner v0.8.0 - A JavaScript framework for conditionally loading UI classes
// Copyright (c) 2013 Rik Schennink - https://github.com/rikschennink/conditioner
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
define(function(){"use strict";var t=function(e,i){var n,o={};for(n in e)e.hasOwnProperty(n)&&(o[n]="object"==typeof e[n]?t(e[n],i[n]):e[n]);for(n in i)i.hasOwnProperty(n)&&(o[n]="object"==typeof i[n]?t(e[n],i[n]):i[n]);return o},e=function(){var t=null,e=document.body;return e.matches?t="matches":e.webkitMatchesSelector?t="webkitMatchesSelector":e.mozMatchesSelector?t="mozMatchesSelector":e.msMatchesSelector?t="msMatchesSelector":e.oMatchesSelector&&(t="oMatchesSelector"),function(e,i){return e?e[t](i):!1}}(),i=function(){return{subscribe:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var n,o=0,r=t._subscriptions;r>o;o++)if(n=t._subscriptions[o],n.type==e&&n.fn==i)return;t._subscriptions.push({type:e,fn:i})},unsubscribe:function(t,e,i){if(t._subscriptions){var n,o;for(o=t._subscriptions.length-1;o>=0;o--)if(n=t._subscriptions[o],n.type==e&&n.fn==i){t._subscriptions.splice(o,1);break}}},publish:function(t,e,i){t._subscriptions||(t._subscriptions=[]);for(var n,o=0,r=t._subscriptions.length;r>o;o++)n=t._subscriptions[o],n.type==e&&n.fn(i);t._eventPropagationTarget&&this.publish(t._eventPropagationTarget,e,i)},setupPropagationTarget:function(t,e){t&&(t._eventPropagationTarget=e)}}}(),n=function(t){var e=function(e,i){if(!e)throw Error('BehaviorBase(element,options): "element" is a required parameter.');this._element=e,this._element.setAttribute("data-initialized","true"),this._options=this._options||{},this._options=i?t(this._options,i):this._options};return e.prototype._unload=function(){this._element.removeAttribute("data-initialized")},e}(t),o=function(t){var e=function(t,e){if(this._element=e,this._state=!0,this._rules=[],t instanceof Array||"object"!=typeof t)this._addRule(t);else if("object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&this._addRule(t[i],i)};e.inherit=function(){var t=function(t,i){e.call(this,t,i)};return t.prototype=Object.create(e.prototype),t};var i=e.prototype;return i._addRule=function(t,e){if(!t)throw Error('TestBase._addRule(value,key): "value" is a required parameter.');this._rules.push({key:e===void 0?"default":e,value:t})},i._test=function(){},i.arrange=function(){},i.assert=function(){for(var e=0,i=this._rules.length,n=!0;i>e;e++)if(!this._test(this._rules[e])){n=!1;break}this._state!=n&&(this._state=n,t.publish(this,"change",n))},i.succeeds=function(){return this._state},e}(i),r={_tests:{},registerTest:function(t,e){if(!t||!e)throw Error('TestManager.defineTest(key,path): Both "key" and "path" are required parameters.');this._tests[t]=e},loadTestByKey:function(t,e){if(!t||!e)throw Error('TestManager.getTestByKey(key,success): Both "key" and "success" are required parameters.');var i=this._tests[t]||"tests/"+t;require([i],function(t){e(t)})}},s={_dependencies:{},registerDependency:function(t,e,i){var n={};n[t]=e;var o={};o[e]=i,requirejs.config({map:{"*":n},config:o}),this._dependencies[t]={options:i||{},dependencies:null,klass:null}},getSpecification:function(t){if(!t)throw Error('DependencyManager.getSpecification(id): "id" is a required parameter.');return this._dependencies[t]}},a=function(t){var e=function(t,e){if(this._suitable=!0,t){if(this._suitable=!1,"string"==typeof t)try{t=JSON.parse(t)}catch(i){return console.warn("ConditionManager(expected,element): expected conditions should be in JSON format."),void 0}this._onResultsChangedBind=this._onTestResultsChanged.bind(this),this._tests=[],this._count=0;var n;for(n in t)t.hasOwnProperty(n)&&(this._count++,this._loadTest(n,t,e))}};return e.prototype={_loadTest:function(e,i,n){var o=this;t.loadTestByKey(e,function(t){var r=new t(i[e],n);o._tests.push(r),o._onLoadTest()})},_onLoadTest:function(){this._count--,0==this._count&&this._onReady()},_onReady:function(){var t,e,n=this._tests.length;for(e=0;n>e;e++)t=this._tests[e],t.arrange(),t.assert(),i.subscribe(t,"change",this._onResultsChangedBind);this.test()},_onTestResultsChanged:function(){this.test()},test:function(){var t,e,n=!0,o=this._tests.length;for(e=0;o>e;e++)if(t=this._tests[e],!t.succeeds()){n=!1;break}n!=this._suitable&&(this._suitable=n,i.publish(this,"change"))},getSuitability:function(){return this._suitable}},e}(r),u=function(t,e,n,o,r){var s=function(t,e){if(!t)throw Error('BehaviorController(id,options): "id" is a required parameter.');this._id=t,this._options=e||{}},a=s.prototype;return a.init=function(){this._conditionManager=new n(this._options.conditions,this._options.target),i.subscribe(this._conditionManager,"change",this._onConditionsChange.bind(this)),this._conditionManager.getSuitability()&&this._loadBehavior()},a._onConditionsChange=function(){var t=this._conditionManager.getSuitability();this._behavior&&!t&&this.unloadBehavior(),!this._behavior&&t&&this._loadBehavior()},a._loadBehavior=function(){var n=this,o=e.getSpecification(this._id);if(o){if(!o.klass)return t([this._id],function(t){t&&(o.klass=t,n._loadBehavior())}),void 0;var s;if("string"==typeof this._options.options)try{s=JSON.parse(this._options.options)}catch(a){}else s=this._options.options;s=r(o.options,s),this._behavior=new o.klass(this._options.target,s),i.setupPropagationTarget(this._behavior,this)}},a.unloadBehavior=function(){return this._behavior?(this._behavior._unload&&this._behavior._unload(),this._behavior=null,!0):!1},a.matchesQuery=function(t){return"string"==typeof t&&o(this._options.target,t)?!0:t==this._options.target},a.execute=function(t,e){if(!this._behavior)return null;var i=this._behavior[t];if(!i)throw Error('Conditioner(method,params): "method" not found on behavior.');return i.apply(this._behavior,e)},s}(require,s,a,e,t),h=function(t,e,i,n,o,r){var s=function(){this._options={attribute:{module:"data-module",conditions:"data-conditions",options:"data-options",priority:"data-priority"}},this._controllers=[]},a=s.prototype;a.setOptions=function(t){this._options=i(this._options,t)},a.registerDependencies=function(){for(var e,i=0,n=arguments.length;n>i;i++)e=arguments[i],t.registerDependency(e.id,e.path,e.options)},a.applyBehavior=function(t){if(!t)throw Error('Conditioner.applyBehavior(context,options): "context" is a required parameter.');var i,n,o,r,s=t.querySelectorAll("["+this._options.attribute.module+"]"),a=s.length,u=0,h=[],c=[];if(!s)return[];for(;a>u;u++)if(n=s[u],"true"!=n.getAttribute("data-processed"))for(n.setAttribute("data-processed","true"),o=this._getBehaviorSpecificationsByElement(n);r=o.shift();)i=new e(r.id,{target:n,conditions:r.conditions,options:r.options}),c.push({controller:i,priority:r.priority}),h.push(i);for(c.sort(function(t,e){return e.priority-t.priority}),a=h.length,u=0;a>u;u++)c[u].controller.init();return this._controllers=this._controllers.concat(h),h},a._getBehaviorSpecificationsByElement=function(t){var e=t.getAttribute(this._options.attribute.module),i="["===e.charAt(0);if(i){for(var n=this._getElementAttributeAsObject(t,this._options.attribute.module),o=this._getElementAttributeAsObject(t,this._options.attribute.conditions),r=this._getElementAttributeAsObject(t,this._options.attribute.options),s=this._getElementAttributeAsObject(t,this._options.attribute.priority),a=n.length,u=0,h=[];a>u;u++)h.push({id:n[u],conditions:o.length?o[u]:o,options:r.length?r[u]:r,priority:s.length?s[u]:s});return h}return[{id:e,conditions:t.getAttribute(this._options.attribute.conditions),options:t.getAttribute(this._options.attribute.options),priority:t.getAttribute(this._options.attribute.priority)}]},a._getElementAttributeAsObject=function(t,e){var i=t.getAttribute(e);if(i)try{return JSON.parse(i)}catch(n){}return[i]},a.getBehavior=function(t){for(var e,i=0,n=this._controllers.length;n>i;i++)if(e=this._controllers[i],e.matchesQuery(t))return e;return null},a.getBehaviorAll=function(t){if(t===void 0)return this._controllers.concat();for(var e,i=0,n=this._controllers.length,o=[];n>i;i++)e=this._controllers[i],e.matchesQuery(t)&&o.push(e);return o};var u;return{getInstance:function(){return u||(u=new s),u},Test:n,Module:o,Observer:r,updateObject:i}}(s,u,t,o,n,i);return h});